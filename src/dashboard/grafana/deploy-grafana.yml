---
- include: ../../common/docker.yml

- name: Create Docker network for dashboard
  docker_network:
    name: dashboard

- name: Create Docker Grafana folder
  file:
    path: /etc/docker/grafana/conf
    state: directory

- name: Create Grafana provisioning folder
  file:
    path: "/etc/docker/grafana/provisioning/{{ item }}"
    state: directory
  loop:
    - datasources
    - dashboards

- name: Copy Grafana Docker Compose
  copy:
    src: "{{ playbook_dir }}/grafana/grafana-docker-compose.yml"
    dest: /etc/docker/grafana

- name: Place Grafana configuration file
  copy:
    src: "{{ playbook_dir }}/grafana/sources/grafana.ini"
    dest: /etc/docker/grafana/conf/grafana.ini

- name: Place Grafana datasource files
  copy:
    src: "{{ item.file }}"
    dest: "/etc/docker/grafana/provisioning/{{ item.fdest }}"
  loop:
    - {
      file: "{{ playbook_dir }}/grafana/sources/datasource.yml",
      fdest: "datasources"
    }

- name: Tear down existing Grafana container
  docker_compose:
    project_src: /etc/docker/grafana
    files:
      - grafana-docker-compose.yml
    state: absent

- name: Run Grafana container
  docker_compose:
    project_src: /etc/docker/grafana
    files:
      - grafana-docker-compose.yml

 # TODO: Include wait for and container state must be running
